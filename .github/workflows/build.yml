# Controls when the workflow will run
on:
  # Allows you to run this workflow manually ftarget the Actions tab
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - { buildtype: 'playdate', repo: 'joyrider3774/formula1_playdate', output: 'formula_1', codesecret: 'FORMULA1_PLAYDATE_CODEKEY', codesecretfile: 'src/codekey.h', makecommand: '"SRC_C_DIR=src/srcgame src/srcgame/scoresubmit"'}
    
    runs-on: ubuntu-latest    
    steps:
      - name: Setup SDK
        run: |
          curl https://github.com/joyrider3774/sdks/releases/latest/download/trimui-sdk.tar.gz --output sdk.tar.gz
          tar -xzvf ./trimui-sdk.tar.gz
          sudo mv ./trimui-sdk /opt/

      - if: ${{ matrix.buildtype == 'playdate'}}
        name: Checkout Playdate SDL2 Api Sources
        uses: actions/checkout@v3
        with:
          repository: 'joyrider3774/Playdate_Api_SDL2'

      - name: Checkout game sources sources
        uses: actions/checkout@v3
        with:
          repository: ${{matrix.repo}}
          path: tmp
      

      - if: ${{ (matrix.codesecret != '') && (matrix.codesecretfile != '')}}
        name: Setup Secret codekey.h File
        env: 
          SECRET: ${{ secrets.${{matrix.codesecret}} }}
        run : |
          echo "$SECRET" | base64 --decode >  tmp/${{matrix.codesecretfile}}
       
      - if: ${{ matrix.buildtype== 'playdate'}}
        name: move things to correct directories
        run: |
          rm -rf ./src/srcgame
          rm -rf ./Source
          mv tmp/Source ./Source
          mv tmp/src ./src/srcgame
     
      - if: ${{ matrix.buildtype == 'playdate'}}   
        name: Build Game
        run: |
          make PLATFORM=trimui_smart_pro ${{matrix.makecommand}}
          
      - if: ${{ matrix.buildtype == 'playdate'}}   
        name: copy metadata
        run: |
          cp -Rf /tmp/metadata/trimuismartpo/. Source/
                 
      - if: ${{ matrix.buildtype == 'playdate'}}
        name: Store build
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.output }} - Trimui_Smart_Pro
          path: Source/
